<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Billing Internet BUMDes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-wifi text-3xl text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">BUMDes Internet</h1>
                        <p class="text-sm text-gray-600">Sistem Billing & Manajemen</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Admin: <strong>Operator BUMDes</strong></span>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="container mx-auto px-6 py-4">
        <div class="bg-white rounded-lg shadow-md p-1">
            <div class="flex space-x-1">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn active flex-1 py-3 px-4 rounded-md font-medium transition-colors">
                    <i class="fas fa-chart-dashboard mr-2"></i>Dashboard
                </button>
                <button onclick="showTab('customers')" id="tab-customers" class="tab-btn flex-1 py-3 px-4 rounded-md font-medium transition-colors">
                    <i class="fas fa-users mr-2"></i>Data Pelanggan
                </button>
                <button onclick="showTab('billing')" id="tab-billing" class="tab-btn flex-1 py-3 px-4 rounded-md font-medium transition-colors">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Tagihan
                </button>
                <button onclick="showTab('notifications')" id="tab-notifications" class="tab-btn flex-1 py-3 px-4 rounded-md font-medium transition-colors">
                    <i class="fas fa-bell mr-2"></i>Notifikasi WA
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-content" class="tab-content container mx-auto px-6 pb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Pelanggan</p>
                        <p class="text-3xl font-bold text-gray-800" id="total-customers">0</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Tagihan Lunas</p>
                        <p class="text-3xl font-bold text-gray-800" id="paid-bills">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Tagihan Tertunggak</p>
                        <p class="text-3xl font-bold text-gray-800" id="unpaid-bills">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Pendapatan Bulan Ini</p>
                        <p class="text-2xl font-bold text-gray-800" id="monthly-revenue">Rp 0</p>
                    </div>
                    <i class="fas fa-money-bill-wave text-3xl text-yellow-500"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Tagihan Jatuh Tempo Hari Ini</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Pelanggan</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Paket</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tagihan</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody id="due-today-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">Tidak ada tagihan jatuh tempo hari ini</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Customers Tab -->
    <div id="customers-content" class="tab-content hidden container mx-auto px-6 pb-8">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Data Pelanggan</h3>
                <button onclick="showAddCustomerModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Tambah Pelanggan
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Alamat</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">No. HP</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Paket</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tarif</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Billing Tab -->
    <div id="billing-content" class="tab-content hidden container mx-auto px-6 pb-8">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Manajemen Tagihan</h3>
                <div class="flex space-x-3">
                    <select id="billing-filter" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="all">Semua Status</option>
                        <option value="paid">Lunas</option>
                        <option value="unpaid">Belum Bayar</option>
                        <option value="overdue">Terlambat</option>
                    </select>
                    <button onclick="generateBills()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-invoice mr-2"></i>Generate Tagihan Bulan Ini
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID Tagihan</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pelanggan</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Periode</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Jumlah</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Jatuh Tempo</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="billing-table" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notifications Tab -->
    <div id="notifications-content" class="tab-content hidden container mx-auto px-6 pb-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Kirim Peringatan WhatsApp</h3>
                <div class="space-y-4">
                    <button onclick="sendBulkReminders()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <i class="fab fa-whatsapp mr-2"></i>Kirim Peringatan ke Semua Tagihan Tertunggak
                    </button>
                    <button onclick="sendDueReminders()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <i class="fas fa-clock mr-2"></i>Kirim Peringatan Jatuh Tempo Hari Ini
                    </button>
                    <button onclick="sendOverdueReminders()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Kirim Peringatan Terlambat
                    </button>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Template Pesan WhatsApp:</h4>
                    <textarea id="wa-template" rows="4" class="w-full border border-gray-300 rounded-lg p-3 text-sm" placeholder="Masukkan template pesan...">Halo {nama},

Tagihan internet BUMDes Anda untuk periode {periode} sebesar {jumlah} akan jatuh tempo pada {tanggal}.

Mohon segera lakukan pembayaran. Terima kasih!</textarea>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Log Notifikasi</h3>
                <div id="notification-log" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-center py-8">Belum ada notifikasi yang dikirim</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Tambah Pelanggan Baru</h3>
                <button onclick="hideAddCustomerModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="add-customer-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="customer-name" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                    <textarea id="customer-address" class="w-full border border-gray-300 rounded-lg px-3 py-2" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">No. HP (WhatsApp)</label>
                    <input type="tel" id="customer-phone" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="08xxxxxxxxxx" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paket Internet</label>
                    <select id="customer-package" class="w-full border border-gray-300 rounded-lg px-3 py-2" required>
                        <option value="">Pilih Paket</option>
                        <option value="Basic 10Mbps">Basic 10Mbps - Rp 150.000</option>
                        <option value="Standard 20Mbps">Standard 20Mbps - Rp 250.000</option>
                        <option value="Premium 50Mbps">Premium 50Mbps - Rp 400.000</option>
                        <option value="Ultra 100Mbps">Ultra 100Mbps - Rp 600.000</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideAddCustomerModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg transition-colors">
                        Batal
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data storage
        let customers = JSON.parse(localStorage.getItem('bumdes-customers') || '[]');
        let bills = JSON.parse(localStorage.getItem('bumdes-bills') || '[]');
        let notifications = JSON.parse(localStorage.getItem('bumdes-notifications') || '[]');

        // Package pricing
        const packages = {
            'Basic 10Mbps': 150000,
            'Standard 20Mbps': 250000,
            'Premium 50Mbps': 400000,
            'Ultra 100Mbps': 600000
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Add sample data if empty
            if (customers.length === 0) {
                addSampleData();
            }
            
            updateDashboard();
            renderCustomers();
            renderBills();
            renderNotifications();
            
            // Add event listeners
            document.getElementById('add-customer-form').addEventListener('submit', addCustomer);
            document.getElementById('billing-filter').addEventListener('change', renderBills);
        });

        function addSampleData() {
            const sampleCustomers = [
                {
                    id: 'C001',
                    name: 'Budi Santoso',
                    address: 'Jl. Merdeka No. 15, RT 02/RW 01',
                    phone: '081234567890',
                    package: 'Standard 20Mbps',
                    status: 'active',
                    joinDate: '2024-01-15'
                },
                {
                    id: 'C002',
                    name: 'Siti Aminah',
                    address: 'Jl. Sudirman No. 8, RT 01/RW 02',
                    phone: '082345678901',
                    package: 'Basic 10Mbps',
                    status: 'active',
                    joinDate: '2024-02-01'
                },
                {
                    id: 'C003',
                    name: 'Ahmad Wijaya',
                    address: 'Jl. Diponegoro No. 22, RT 03/RW 01',
                    phone: '083456789012',
                    package: 'Premium 50Mbps',
                    status: 'active',
                    joinDate: '2024-01-20'
                }
            ];
            
            customers = sampleCustomers;
            localStorage.setItem('bumdes-customers', JSON.stringify(customers));
            
            // Generate sample bills
            generateBills();
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function updateDashboard() {
            const totalCustomers = customers.length;
            const paidBills = bills.filter(bill => bill.status === 'paid').length;
            const unpaidBills = bills.filter(bill => bill.status === 'unpaid' || bill.status === 'overdue').length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyRevenue = bills
                .filter(bill => {
                    const billDate = new Date(bill.dueDate);
                    return bill.status === 'paid' && 
                           billDate.getMonth() === currentMonth && 
                           billDate.getFullYear() === currentYear;
                })
                .reduce((sum, bill) => sum + bill.amount, 0);

            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('paid-bills').textContent = paidBills;
            document.getElementById('unpaid-bills').textContent = unpaidBills;
            document.getElementById('monthly-revenue').textContent = formatCurrency(monthlyRevenue);

            // Update due today table
            const today = new Date().toISOString().split('T')[0];
            const dueToday = bills.filter(bill => bill.dueDate === today && bill.status !== 'paid');
            
            const dueTable = document.getElementById('due-today-table');
            if (dueToday.length === 0) {
                dueTable.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Tidak ada tagihan jatuh tempo hari ini</td></tr>';
            } else {
                dueTable.innerHTML = dueToday.map(bill => {
                    const customer = customers.find(c => c.id === bill.customerId);
                    return `
                        <tr>
                            <td class="px-4 py-3">${customer?.name || 'Unknown'}</td>
                            <td class="px-4 py-3">${customer?.package || 'Unknown'}</td>
                            <td class="px-4 py-3">${formatCurrency(bill.amount)}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                    Jatuh Tempo
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function renderCustomers() {
            const table = document.getElementById('customers-table');
            
            if (customers.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Belum ada data pelanggan</td></tr>';
                return;
            }

            table.innerHTML = customers.map(customer => `
                <tr>
                    <td class="px-4 py-3 font-medium">${customer.id}</td>
                    <td class="px-4 py-3">${customer.name}</td>
                    <td class="px-4 py-3">${customer.address}</td>
                    <td class="px-4 py-3">${customer.phone}</td>
                    <td class="px-4 py-3">${customer.package}</td>
                    <td class="px-4 py-3">${formatCurrency(packages[customer.package] || 0)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${customer.status === 'active' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editCustomer('${customer.id}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderBills() {
            const filter = document.getElementById('billing-filter').value;
            let filteredBills = bills;
            
            if (filter !== 'all') {
                filteredBills = bills.filter(bill => bill.status === filter);
            }

            const table = document.getElementById('billing-table');
            
            if (filteredBills.length === 0) {
                table.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Tidak ada data tagihan</td></tr>';
                return;
            }

            table.innerHTML = filteredBills.map(bill => {
                const customer = customers.find(c => c.id === bill.customerId);
                const statusClass = {
                    'paid': 'bg-green-100 text-green-800',
                    'unpaid': 'bg-yellow-100 text-yellow-800',
                    'overdue': 'bg-red-100 text-red-800'
                };
                
                const statusText = {
                    'paid': 'Lunas',
                    'unpaid': 'Belum Bayar',
                    'overdue': 'Terlambat'
                };

                return `
                    <tr>
                        <td class="px-4 py-3 font-medium">${bill.id}</td>
                        <td class="px-4 py-3">${customer?.name || 'Unknown'}</td>
                        <td class="px-4 py-3">${bill.period}</td>
                        <td class="px-4 py-3">${formatCurrency(bill.amount)}</td>
                        <td class="px-4 py-3">${formatDate(bill.dueDate)}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass[bill.status]}">
                                ${statusText[bill.status]}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2">
                                ${bill.status !== 'paid' ? `
                                    <button onclick="markAsPaid('${bill.id}')" class="text-green-600 hover:text-green-800" title="Tandai Lunas">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                <button onclick="sendIndividualReminder('${bill.id}')" class="text-blue-600 hover:text-blue-800" title="Kirim Peringatan">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderNotifications() {
            const logContainer = document.getElementById('notification-log');
            
            if (notifications.length === 0) {
                logContainer.innerHTML = '<div class="text-gray-500 text-center py-8">Belum ada notifikasi yang dikirim</div>';
                return;
            }

            logContainer.innerHTML = notifications.slice(-10).reverse().map(notif => `
                <div class="p-3 border border-gray-200 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium text-gray-800">${notif.recipient}</span>
                        <span class="text-xs text-gray-500">${formatDateTime(notif.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-600">${notif.message}</p>
                    <div class="mt-2">
                        <span class="px-2 py-1 text-xs rounded-full ${notif.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${notif.status === 'sent' ? 'Terkirim' : 'Demo Mode'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function showAddCustomerModal() {
            document.getElementById('add-customer-modal').classList.remove('hidden');
            document.getElementById('add-customer-modal').classList.add('flex');
        }

        function hideAddCustomerModal() {
            document.getElementById('add-customer-modal').classList.add('hidden');
            document.getElementById('add-customer-modal').classList.remove('flex');
            document.getElementById('add-customer-form').reset();
        }

        function addCustomer(e) {
            e.preventDefault();
            
            const name = document.getElementById('customer-name').value;
            const address = document.getElementById('customer-address').value;
            const phone = document.getElementById('customer-phone').value;
            const packageName = document.getElementById('customer-package').value;
            
            const newCustomer = {
                id: 'C' + String(customers.length + 1).padStart(3, '0'),
                name,
                address,
                phone,
                package: packageName,
                status: 'active',
                joinDate: new Date().toISOString().split('T')[0]
            };
            
            customers.push(newCustomer);
            localStorage.setItem('bumdes-customers', JSON.stringify(customers));
            
            hideAddCustomerModal();
            renderCustomers();
            updateDashboard();
            
            alert('Pelanggan berhasil ditambahkan!');
        }

        function generateBills() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const period = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
            
            // Check if bills already generated for this month
            const existingBills = bills.filter(bill => bill.period === period);
            if (existingBills.length > 0) {
                alert('Tagihan untuk bulan ini sudah dibuat!');
                return;
            }
            
            const newBills = customers.filter(c => c.status === 'active').map((customer, index) => {
                const dueDate = new Date(currentYear, currentMonth, 25); // Due on 25th of each month
                
                return {
                    id: 'B' + currentYear + String(currentMonth + 1).padStart(2, '0') + String(index + 1).padStart(3, '0'),
                    customerId: customer.id,
                    period,
                    amount: packages[customer.package] || 0,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: 'unpaid',
                    createdDate: new Date().toISOString().split('T')[0]
                };
            });
            
            bills.push(...newBills);
            localStorage.setItem('bumdes-bills', JSON.stringify(bills));
            
            renderBills();
            updateDashboard();
            
            alert(`${newBills.length} tagihan berhasil dibuat untuk periode ${period}!`);
        }

        function markAsPaid(billId) {
            const bill = bills.find(b => b.id === billId);
            if (bill) {
                bill.status = 'paid';
                bill.paidDate = new Date().toISOString().split('T')[0];
                localStorage.setItem('bumdes-bills', JSON.stringify(bills));
                
                renderBills();
                updateDashboard();
                
                alert('Tagihan berhasil ditandai sebagai lunas!');
            }
        }

        function sendBulkReminders() {
            const unpaidBills = bills.filter(bill => bill.status === 'unpaid' || bill.status === 'overdue');
            
            if (unpaidBills.length === 0) {
                alert('Tidak ada tagihan tertunggak untuk dikirim peringatan.');
                return;
            }
            
            unpaidBills.forEach(bill => {
                sendReminder(bill);
            });
            
            alert(`Peringatan WhatsApp berhasil dikirim ke ${unpaidBills.length} pelanggan!`);
        }

        function sendDueReminders() {
            const today = new Date().toISOString().split('T')[0];
            const dueBills = bills.filter(bill => bill.dueDate === today && bill.status !== 'paid');
            
            if (dueBills.length === 0) {
                alert('Tidak ada tagihan jatuh tempo hari ini.');
                return;
            }
            
            dueBills.forEach(bill => {
                sendReminder(bill);
            });
            
            alert(`Peringatan jatuh tempo berhasil dikirim ke ${dueBills.length} pelanggan!`);
        }

        function sendOverdueReminders() {
            const today = new Date();
            const overdueBills = bills.filter(bill => {
                const dueDate = new Date(bill.dueDate);
                return dueDate < today && bill.status !== 'paid';
            });
            
            // Update status to overdue
            overdueBills.forEach(bill => {
                bill.status = 'overdue';
            });
            localStorage.setItem('bumdes-bills', JSON.stringify(bills));
            
            if (overdueBills.length === 0) {
                alert('Tidak ada tagihan terlambat.');
                return;
            }
            
            overdueBills.forEach(bill => {
                sendReminder(bill);
            });
            
            renderBills();
            updateDashboard();
            alert(`Peringatan terlambat berhasil dikirim ke ${overdueBills.length} pelanggan!`);
        }

        function sendIndividualReminder(billId) {
            const bill = bills.find(b => b.id === billId);
            if (bill) {
                sendReminder(bill);
                alert('Peringatan WhatsApp berhasil dikirim!');
            }
        }

        function sendReminder(bill) {
            const customer = customers.find(c => c.id === bill.customerId);
            if (!customer) return;
            
            const template = document.getElementById('wa-template').value;
            const message = template
                .replace('{nama}', customer.name)
                .replace('{periode}', bill.period)
                .replace('{jumlah}', formatCurrency(bill.amount))
                .replace('{tanggal}', formatDate(bill.dueDate));
            
            // In a real application, this would integrate with WhatsApp Business API
            // For demo purposes, we'll just log the notification
            const notification = {
                id: 'N' + Date.now(),
                recipient: customer.name,
                phone: customer.phone,
                message: message,
                billId: bill.id,
                timestamp: new Date().toISOString(),
                status: 'demo' // In real app: 'sent', 'failed', etc.
            };
            
            notifications.push(notification);
            localStorage.setItem('bumdes-notifications', JSON.stringify(notifications));
            
            renderNotifications();
            
            // Simulate WhatsApp link (for demo)
            const whatsappUrl = `https://wa.me/${customer.phone.replace(/^0/, '62')}?text=${encodeURIComponent(message)}`;
            console.log('WhatsApp URL:', whatsappUrl);
        }

        function editCustomer(customerId) {
            alert('Fitur edit pelanggan akan segera tersedia!');
        }

        function deleteCustomer(customerId) {
            if (confirm('Apakah Anda yakin ingin menghapus pelanggan ini?')) {
                customers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('bumdes-customers', JSON.stringify(customers));
                
                renderCustomers();
                updateDashboard();
                
                alert('Pelanggan berhasil dihapus!');
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>

    <style>
        .tab-btn {
            @apply text-gray-600 hover:text-blue-600 hover:bg-blue-50;
        }
        
        .tab-btn.active {
            @apply bg-blue-600 text-white;
        }
        
        .tab-btn:hover.active {
            @apply bg-blue-700 text-white;
        }
    </style>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97970ed9e58ffcee',t:'MTc1NjkyMTQ5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
